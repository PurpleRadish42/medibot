<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Image Analyzer - Test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
        }
        .upload-section {
            border: 2px dashed #4facfe;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }
        .upload-section:hover {
            background: rgba(79, 172, 254, 0.1);
        }
        #fileInput {
            display: none;
        }
        .preview-section {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .preview-section img {
            max-width: 400px;
            max-height: 300px;
            border-radius: 10px;
        }
        .btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .btn:hover {
            background: #3d8bfe;
        }
        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-user-md"></i> Medical Image Analyzer</h1>
        <p>Upload or take a photo for AI-powered medical analysis</p>
        
        <!-- Upload Section -->
        <div class="upload-section" onclick="triggerFileInput()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #4facfe; margin-bottom: 10px;"></i>
            <h3>Click to Upload Image</h3>
            <p>Supports JPG, PNG formats</p>
        </div>
        
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        
        <!-- Camera Section -->
        <div style="text-align: center;">
            <button class="btn" onclick="startCamera()">
                <i class="fas fa-camera"></i> Use Camera
            </button>
        </div>
        
        <div id="cameraSection" style="display: none; text-align: center; margin: 20px 0;">
            <video id="videoElement" width="400" height="300" autoplay style="border-radius: 10px;"></video>
            <br>
            <button class="btn" onclick="capturePhoto()">
                <i class="fas fa-camera"></i> Capture
            </button>
            <button class="btn" onclick="stopCamera()" style="background: #dc3545;">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
        
        <!-- Preview Section -->
        <div id="previewSection" class="preview-section">
            <h3>Image Preview</h3>
            <img id="imagePreview" src="" alt="Preview">
            <br>
            <button class="btn" onclick="analyzeImage()">
                <i class="fas fa-search"></i> Analyze Image
            </button>
            <button class="btn" onclick="removeImage()" style="background: #6c757d;">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
        
        <!-- Loading Section -->
        <div id="loadingSection" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Analyzing image with AI...</p>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <h3><i class="fas fa-chart-bar"></i> Analysis Results</h3>
            <div id="analysisResults"></div>
        </div>
    </div>

    <script>
        let selectedImage = null;
        let currentStream = null;

        function triggerFileInput() {
            console.log('Triggering file input...');
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            console.log('File selected:', event.target.files[0]);
            const file = event.target.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert('File size too large. Please select an image under 10MB.');
                    return;
                }
                
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    displayPreview(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPreview(imageSrc) {
            document.getElementById('imagePreview').src = imageSrc;
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            stopCamera(); // Stop camera if active
        }

        function removeImage() {
            selectedImage = null;
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 400, height: 300 } 
                });
                currentStream = stream;
                document.getElementById('videoElement').srcObject = stream;
                document.getElementById('cameraSection').style.display = 'block';
            } catch (error) {
                console.error('Camera error:', error);
                alert('Could not access camera. Please check permissions or try uploading an image instead.');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraSection').style.display = 'none';
        }

        function capturePhoto() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(function(blob) {
                selectedImage = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
                displayPreview(canvas.toDataURL('image/jpeg', 0.8));
                stopCamera();
            }, 'image/jpeg', 0.8);
        }

        async function analyzeImage() {
            if (!selectedImage) {
                alert('Please select an image first.');
                return;
            }

            // Show loading
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('image', selectedImage);
                formData.append('image_type', 'skin');
                formData.append('symptoms', 'User uploaded image for analysis');

                const response = await fetch('/api/v1/analyze-skin', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                // Hide loading
                document.getElementById('loadingSection').style.display = 'none';
                
                if (result.success) {
                    displayResults(result);
                } else {
                    document.getElementById('analysisResults').innerHTML = `
                        <div style="color: #dc3545;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Analysis Failed:</strong> ${result.message || 'Unknown error'}
                        </div>
                    `;
                    document.getElementById('resultsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analysisResults').innerHTML = `
                    <div style="color: #dc3545;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Network Error:</strong> Could not connect to analysis service.
                    </div>
                `;
                document.getElementById('resultsSection').style.display = 'block';
            }
        }

        function displayResults(result) {
            const analysis = result.analysis;
            let html = '';

            // Analysis summary
            if (analysis.summary) {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 8px;">
                        <h4><i class="fas fa-info-circle"></i> Analysis Summary</h4>
                        <p>${analysis.summary}</p>
                    </div>
                `;
            }

            // Detected conditions
            if (analysis.conditions && analysis.conditions.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4><i class="fas fa-stethoscope"></i> Detected Conditions</h4>
                `;
                
                analysis.conditions.forEach((condition, index) => {
                    const confidenceColor = condition.confidence > 70 ? '#28a745' : 
                                          condition.confidence > 50 ? '#ffc107' : '#dc3545';
                    html += `
                        <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                            <strong>${condition.name}</strong>
                            <span style="color: ${confidenceColor}; margin-left: 10px;">
                                ${Math.round(condition.confidence)}% confidence
                            </span>
                            ${condition.source ? `<small style="opacity: 0.7;"> (${condition.source})</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4><i class="fas fa-clipboard-list"></i> Recommendations</h4>
                        <ul style="margin-left: 20px;">
                `;
                analysis.recommendations.forEach(rec => {
                    html += `<li style="margin: 5px 0;">${rec}</li>`;
                });
                html += '</ul></div>';
            }

            // Analysis methods used
            if (analysis.analysis_methods && analysis.analysis_methods.length > 0) {
                html += `
                    <div style="margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                        <small><i class="fas fa-cogs"></i> Analysis methods: ${analysis.analysis_methods.join(', ')}</small>
                        <br>
                        <small><i class="fas fa-percentage"></i> Overall confidence: ${Math.round(analysis.overall_confidence || 0)}%</small>
                    </div>
                `;
            }

            document.getElementById('analysisResults').innerHTML = html;
            document.getElementById('resultsSection').style.display = 'block';
        }

        // Test file input on page load
        window.onload = function() {
            console.log('Page loaded. Testing file input...');
            const fileInput = document.getElementById('fileInput');
            console.log('File input element:', fileInput);
        };
    </script>
</body>
</html>
